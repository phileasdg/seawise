<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seawise - Premium Marine Navigation</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: {
                            50: '#f0f4f8',
                            100: '#d9e5f0',
                            200: '#b3cce0',
                            300: '#8db2d0',
                            400: '#6798c0',
                            500: '#417eb0',
                            600: '#1a4c73',
                            700: '#0f2d44',
                            800: '#081b29',
                            900: '#04111a'
                        },
                        maritime: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a'
                        }
                    },
                    fontFamily: {
                        'display': ['Playfair Display', 'serif'],
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    },
                    backdropBlur: {
                        'xs': '2px',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'ripple': 'ripple 0.6s ease-out',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-4px)' }
                        },
                        shimmer: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        ripple: {
                            '0%': { transform: 'scale(0)', opacity: '1' },
                            '100%': { transform: 'scale(4)', opacity: '0' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- i-Boating / BLC Maps SDK -->
    <link rel='stylesheet' href='https://fishing-app.gpsnauticalcharts.com/i-boating-fishing-marine-navigation-sdk/5.5/blc-maps.css' />
    <script src='https://fishing-app.gpsnauticalcharts.com/i-boating-fishing-marine-navigation-sdk/5.5/blc-maps.js'></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b  100%);
        }
        
        #map {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        .leaflet-gl-layer {
            pointer-events: auto;
        }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 8px 32px rgba(15, 23, 42, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }
        
        .glass-button {
            background: rgba(51, 65, 85, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .glass-button:hover {
            background: rgba(71, 85, 105, 0.8);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 
                0 10px 25px rgba(15, 23, 42, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .glass-button:active {
            transform: translateY(0);
        }
        
        .panel-wrapper {
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .panel-wrapper-collapsed-left {
            transform: translateX(calc(-100% + 52px));
        }
        
        .panel-wrapper-collapsed-right {
            transform: translateX(calc(100% - 52px));
        }
        
        .toggle-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .toggle-button svg {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .toggle-button.active svg {
            transform: rotate(180deg);
        }
        
        .luxury-input {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(12px);
            transition: all 0.3s ease;
        }
        
        .luxury-input:focus {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(65, 126, 176, 0.6);
            box-shadow: 0 0 0 3px rgba(65, 126, 176, 0.15);
        }
        
        .radio-luxury {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            background: rgba(30, 41, 59, 0.6);
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .radio-luxury:checked {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.3);
        }
        
        .radio-luxury:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #60a5fa;
        }
        
        .location-btn, .tool-btn {
            position: relative;
            overflow: hidden;
        }
        
        .location-btn::before, .tool-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .location-btn:hover::before, .tool-btn:hover::before {
            left: 100%;
        }
        
        .coordinates-display {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .brand-title {
            background: linear-gradient(135deg, #417eb0 0%, #64748b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .floating-animation {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes ripple-effect {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(4); opacity: 0; }
        }
        
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            pointer-events: none;
            animation: ripple-effect 0.6s ease-out;
        }
    </style>
</head>
<body>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[2000] flex flex-col-reverse items-center space-y-3 space-y-reverse"></div>

    <!-- Info Panel Wrapper (Left) -->
    <div id="info-panel-wrapper" class="panel-wrapper fixed top-6 left-6 z-[1100] flex items-start">
        <div id="info-panel-container" class="glass-panel rounded-l-2xl p-6 max-w-sm w-full md:w-auto animate-fade-in">
            <div class="space-y-5">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-navy-500 to-navy-700 flex items-center justify-center floating-animation">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2s2.5 2 5 2 2.5-2 5-2 2.5 2 5 2c1.3 0 1.9-.5 2.5-1"></path>
                            <path d="M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2s2.5 2 5 2 2.5-2 5-2 2.5 2 5 2c1.3 0 1.9-.5 2.5-1"></path>
                            <path d="M2 15c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2s2.5 2 5 2 2.5-2 5-2 2.5 2 5 2c1.3 0 1.9-.5 2.5-1"></path>
                            <rect x="7" y="3" width="10" height="6" rx="2"></rect>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-display font-semibold brand-title">Seawise</h3>
                </div>
                <div class="h-px bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>
                <p class="text-sm text-white/80 leading-relaxed font-light">Premium marine navigation and chart viewing for discerning mariners</p>
                <div class="space-y-2">
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 rounded-full bg-navy-400 animate-pulse"></div>
                        <span class="font-medium text-sm text-white/90">Current Position</span>
                    </div>
                    <span id="current-location" class="text-sm text-white/70 ml-4 font-mono">Bar Harbor, Maine</span>
                </div>
            </div>
        </div>
        <button id="info-toggle" class="toggle-button active glass-button p-3 rounded-r-2xl text-white/80 hover:text-white">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="9" y1="18" x2="15" y2="12"></line>
                <line x1="9" y1="6" x2="15" y2="12"></line>
            </svg>
        </button>
    </div>

    <!-- Controls Panel Wrapper (Right) -->
    <div id="controls-panel-wrapper" class="panel-wrapper fixed top-6 right-6 z-[1000] flex items-start">
        <button id="controls-toggle" class="toggle-button active glass-button p-3 rounded-l-2xl text-white/80 hover:text-white">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="15" y1="18" x2="9" y2="12"></line>
                <line x1="15" y1="6" x2="9" y2="12"></line>
            </svg>
        </button>
        <div id="controls-panel-container" class="glass-panel rounded-r-2xl p-6 max-w-sm w-full md:w-auto animate-fade-in">
            <div class="space-y-6">
                <!-- Location Search -->
                <div class="space-y-3">
                    <label for="location-search" class="font-semibold text-white/90 text-sm flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <span>Navigation Search</span>
                    </label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="location-search" class="luxury-input block w-full rounded-xl px-4 py-3 text-white placeholder-white/50 text-sm focus:outline-none" placeholder="e.g., Nantucket Sound">
                        <button id="search-btn" class="glass-button p-3 rounded-xl text-white/80 hover:text-white shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="h-px bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>

                <!-- Layer Controls -->
                <div class="space-y-4">
                    <label class="font-semibold text-white/90 text-sm flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                            <polyline points="2,17 12,22 22,17"></polyline>
                            <polyline points="2,12 12,17 22,12"></polyline>
                        </svg>
                        <span>Chart Layers</span>
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="flex items-center space-x-3">
                            <input type="radio" id="nautical" name="baselayer" value="nautical" class="radio-luxury">
                            <label for="nautical" class="text-sm text-white/80 cursor-pointer">Nautical</label>
                        </div>
                        <div class="flex items-center space-x-3">
                            <input type="radio" id="satellite" name="baselayer" value="satellite" class="radio-luxury">
                            <label for="satellite" class="text-sm text-white/80 cursor-pointer">Satellite</label>
                        </div>
                        <div class="flex items-center space-x-3">
                            <input type="radio" id="osm" name="baselayer" value="osm" class="radio-luxury">
                            <label for="osm" class="text-sm text-white/80 cursor-pointer">Coastal</label>
                        </div>
                        <div class="flex items-center space-x-3">
                            <input type="radio" id="terrain" name="baselayer" value="terrain" class="radio-luxury">
                            <label for="terrain" class="text-sm text-white/80 cursor-pointer">Terrain</label>
                        </div>
                    </div>
                </div>

                <div class="h-px bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>

                <!-- Quick Locations -->
                <div class="space-y-4">
                    <label class="font-semibold text-white/90 text-sm flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        <span>Premier Destinations</span>
                    </label>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="goToLocation(44.3876, -68.2039, 'Bar Harbor, Maine')" class="location-btn glass-button px-3 py-2.5 text-xs font-medium text-white/80 hover:text-white rounded-lg transition-all duration-300">Bar Harbor</button>
                        <button onclick="goToLocation(37.8269, -122.3990, 'San Francisco Bay')" class="location-btn glass-button px-3 py-2.5 text-xs font-medium text-white/80 hover:text-white rounded-lg transition-all duration-300">SF Bay</button>
                        <button onclick="goToLocation(25.7617, -80.1918, 'Miami Beach')" class="location-btn glass-button px-3 py-2.5 text-xs font-medium text-white/80 hover:text-white rounded-lg transition-all duration-300">Miami</button>
                        <button onclick="goToLocation(41.3851, -71.4774, 'Narragansett Bay')" class="location-btn glass-button px-3 py-2.5 text-xs font-medium text-white/80 hover:text-white rounded-lg transition-all duration-300">Narragansett</button>
                    </div>
                </div>

                <div class="h-px bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>

                <!-- Map Tools -->
                <div class="space-y-4">
                    <label class="font-semibold text-white/90 text-sm flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
                        </svg>
                        <span>Navigation Tools</span>
                    </label>
                    <button onclick="getCurrentLocation()" class="tool-btn glass-button w-full px-4 py-3 text-sm font-medium text-white/80 hover:text-white rounded-lg flex items-center justify-center space-x-2 transition-all duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        <span>Current Position</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Coordinates Display -->
    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[1000] coordinates-display text-white/90 text-xs font-mono px-4 py-2.5 rounded-xl shadow-lg">
        <span id="coordinates">44.3876°N, 68.2039°W</span>
    </div>

    <script>
        // Apply ripple effect to buttons
        function addRippleEffect(element) {
            element.addEventListener('click', function(e) {
                const rect = element.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                
                const ripple = document.createElement('span');
                ripple.className = 'ripple';
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                
                element.appendChild(ripple);
                
                setTimeout(() => ripple.remove(), 600);
            });
        }

        // Add ripple to all buttons when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('button, .location-btn, .tool-btn').forEach(addRippleEffect);
        });

        // --- BLC Maps Adapter (i-Boating) ---
        (function (root, factory) {
            if (typeof define === 'function' && define.amd) {
                define(['leaflet', 'blc-maps'], factory);
            } else if (typeof exports === 'object') {
                module.exports = factory(require('leaflet'), require('blc-maps'));
            } else {
                root.returnExports = factory(window.L, window.blcgl);
            }
        }(this, function (L, blcgl) {
            if (!L || !L.Layer) return;
            L.BlcGL = L.Layer.extend({
                options: { updateInterval: 32, padding: 0.1, interactive: false, pane: 'tilePane' },
                initialize: function (options) {
                    L.setOptions(this, options);
                    if (options.blc_access_token) blcgl.accessToken = options.blc_access_token;
                    this._throttledUpdate = L.Util.throttle(this._update, this.options.updateInterval, this);
                },
                onAdd: function (map) {
                    if (!this._container) this._initContainer();
                    map.getPane(this.getPaneName()).appendChild(this._container);
                    this._initGL();
                    this._offset = this._map.containerPointToLayerPoint([0, 0]);
                    if (map.options.zoomAnimation) L.DomEvent.on(map._proxy, L.DomUtil.TRANSITION_END, this._transitionEnd, this);
                    if (map._addZoomLimit) map._addZoomLimit(this);
                },
                onRemove: function (map) {
                    if (this._map._proxy && this._map.options.zoomAnimation) L.DomEvent.off(this._map._proxy, L.DomUtil.TRANSITION_END, this._transitionEnd, this);
                    var paneName = this.getPaneName();
                    if (map.getPane(paneName) && this._container) map.getPane(paneName).removeChild(this._container);
                    if (this._glMap && this._glMap.remove) this._glMap.remove();
                },
                getEvents: function () { return { move: this._throttledUpdate, zoomanim: this._animateZoom, zoom: this._pinchZoom, zoomstart: this._zoomStart, zoomend: this._zoomEnd, resize: this._resize }; },
                getBlcGLMap: function () { return this._glMap; },
                getCanvas: function () { return this._glMap ? this._glMap.getCanvas() : null; },
                getSize: function () { return this._map.getSize().multiplyBy(1 + this.options.padding * 2); },
                getBounds: function () {
                    var halfSize = this.getSize().multiplyBy(0.5);
                    var center = this._map.latLngToContainerPoint(this._map.getCenter());
                    return L.latLngBounds(this._map.containerPointToLatLng(center.subtract(halfSize)), this._map.containerPointToLatLng(center.add(halfSize)));
                },
                getContainer: function () { return this._container; },
                getPaneName: function () { return this._map.getPane(this.options.pane) ? this.options.pane : 'tilePane'; },
                _initContainer: function () {
                    var container = this._container = L.DomUtil.create('div', 'leaflet-gl-layer');
                    var size = this.getSize();
                    var offset = this._map.getSize().multiplyBy(this.options.padding);
                    container.style.width  = size.x + 'px';
                    container.style.height = size.y + 'px';
                    var topLeft = this._map.containerPointToLayerPoint([0, 0]).subtract(offset);
                    L.DomUtil.setPosition(container, topLeft);
                },
                _initGL: function () {
                    var center = this._map.getCenter();
                    var options = L.extend({}, this.options, { container: this._container, center: [center.lng, center.lat], zoom: this._map.getZoom() - 1, blc_enable_leaflet_compatibility: true, attributionControl: false });
                    try {
                        if (!this._glMap && window.blcgl && window.blcgl.external_to_js) this._glMap = new blcgl.external_to_js.blcCreateMapObject(options);
                        else if (this._glMap) { this._glMap.setCenter(options.center); this._glMap.setZoom(options.zoom); }
                        if (this._glMap) {
                            this._glMap.transform.latRange = null; this._transformGL(this._glMap);
                            this._glMap._actualCanvas = this._glMap._canvas.canvas || this._glMap._canvas || (this._glMap.getCanvas ? this._glMap.getCanvas() : null);
                            if (this._glMap._actualCanvas) {
                                var canvas = this._glMap._actualCanvas;
                                L.DomUtil.addClass(canvas, 'leaflet-image-layer leaflet-zoom-animated');
                                if (this.options.interactive) L.DomUtil.addClass(canvas, 'leaflet-interactive');
                                if (this.options.className) L.DomUtil.addClass(canvas, this.options.className);
                            }
                        }
                    } catch (error) { console.error('Error initializing BLC GL Map:', error); throw error; }
                },
                _update: function (e) {
                    if (!this._map || !this._glMap) return;
                    this._offset = this._map.containerPointToLayerPoint([0, 0]);
                    if (this._zooming) return;
                    var size = this.getSize(), container = this._container, gl = this._glMap, offset = this._map.getSize().multiplyBy(this.options.padding), topLeft = this._map.containerPointToLayerPoint([0, 0]).subtract(offset);
                    L.DomUtil.setPosition(container, topLeft);
                    this._transformGL(gl);
                    var x_round = Math.round(size.x), y_round = Math.round(size.y);
                    if (Math.round(gl.transform.width) !== x_round || Math.round(gl.transform.height) !== y_round) {
                        container.style.width  = x_round + 'px'; container.style.height = y_round + 'px';
                        if (gl._resize) gl._resize(); else if (gl.resize) gl.resize();
                    } else {
                        if (gl._update) gl._update(); else if (gl.update) gl.update();
                    }
                },
                _transformGL: function (gl) {
                    if (!gl || !gl.transform) return;
                    var center = this._map.getCenter(); var tr = gl.transform;
                    if (blcgl && blcgl.LngLat && blcgl.LngLat.convert) tr.center = blcgl.LngLat.convert([center.lng, center.lat]);
                    else tr.center = {lng: center.lng, lat: center.lat};
                    tr.zoom = this._map.getZoom() - 1;
                },
                _pinchZoom: function (e) { if (this._glMap && this._glMap.jumpTo) this._glMap.jumpTo({ zoom: this._map.getZoom() - 1, center: this._map.getCenter() }); },
                _animateZoom: function (e) {
                    if (!this._glMap || !this._glMap._actualCanvas) return;
                    var scale = this._map.getZoomScale(e.zoom), padding = this._map.getSize().multiplyBy(this.options.padding * scale), viewHalf = this.getSize()._divideBy(2);
                    var topLeft = this._map.project(e.center, e.zoom)._subtract(viewHalf)._add(this._map._getMapPanePos().add(padding))._round();
                    var offset = this._map.project(this._map.getBounds().getNorthWest(), e.zoom)._subtract(topLeft);
                    L.DomUtil.setTransform(this._glMap._actualCanvas, offset.subtract(this._offset), scale);
                },
                _zoomStart: function (e) { this._zooming = true; },
                _zoomEnd: function () {
                    if (!this._glMap || !this._glMap._actualCanvas) return;
                    var scale = this._map.getZoomScale(this._map.getZoom());
                    L.DomUtil.setTransform(this._glMap._actualCanvas, null, scale);
                    this._zooming = false; this._update();
                },
                _transitionEnd: function (e) {
                    var self = this;
                    L.Util.requestAnimFrame(function () {
                        if (!self._glMap) return;
                        var zoom = self._map.getZoom(), center = self._map.getCenter(), offset = self._map.latLngToContainerPoint(self._map.getBounds().getNorthWest());
                        if (self._glMap._actualCanvas) L.DomUtil.setTransform(self._glMap._actualCanvas, offset, 1);
                        if (self._glMap.once && self._glMap.jumpTo) {
                            self._glMap.once('moveend', L.Util.bind(function () { self._zoomEnd(); }, self));
                            self._glMap.jumpTo({ center: center, zoom: zoom - 1 });
                        }
                    });
                },
                _resize: function (e) { this._transitionEnd(e); }
            });
            L.blcGL = function (options) { return new L.BlcGL(options); };
            return L.BlcGL;
        }));

        // --- Application Logic ---

        // Global variables
        let map;
        let nauticalLayer = null;
        let currentBaseLayer = null;
        const BLC_MAPS_TOKEN = 'wYhXj07uz1kfDTKR1qxuBn'; // Default i-Boating token

        // Base layer definitions
        const baseLayers = {
            osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 18,
                attribution: '&copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                maxZoom: 17,
                attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (CC-BY-SA)'
            })
        };

        /**
         * Initializes the Leaflet map and its components.
         */
        function initializeMap() {
            map = L.map('map', {
                zoomControl: false // Add it manually in a different position
            }).setView([44.3876, -68.2039], 13); // Bar Harbor, Maine coordinates

            // Customize zoom control
            L.control.zoom({ 
                position: 'bottomright',
                zoomInTitle: 'Zoom In',
                zoomOutTitle: 'Zoom Out'
            }).addTo(map);
            
            L.control.scale({ 
                position: 'bottomleft',
                metric: true,
                imperial: true
            }).addTo(map);

            // Default to nautical charts on load
            document.getElementById('nautical').checked = true;
            switchToLayer('nautical');
        }

        /**
         * Switches the active map layer.
         * @param {string} layerType - The key of the layer to switch to.
         */
        function switchToLayer(layerType) {
            if (currentBaseLayer) map.removeLayer(currentBaseLayer);
            if (nauticalLayer) map.removeLayer(nauticalLayer);
            
            currentBaseLayer = null;
            nauticalLayer = null;

            if (layerType === 'nautical') {
                if (!createNauticalLayer()) {
                    showToast('Nautical charts unavailable. Switching to Coastal view.', 'warning');
                    document.getElementById('osm').checked = true;
                    currentBaseLayer = baseLayers.osm;
                    currentBaseLayer.addTo(map);
                }
            } else {
                currentBaseLayer = baseLayers[layerType];
                if (currentBaseLayer) {
                    currentBaseLayer.addTo(map);
                    showToast(`Switched to ${layerType.charAt(0).toUpperCase() + layerType.slice(1)} view`, 'success');
                }
            }
        }

        /**
         * Creates and adds the i-Boating nautical chart layer.
         * @returns {boolean} - True if successful, false otherwise.
         */
        function createNauticalLayer() {
            if (!BLC_MAPS_TOKEN) {
                showToast('Nautical chart access unavailable.', 'error');
                return false;
            }
            try {
                nauticalLayer = L.blcGL({
                    blc_access_token: BLC_MAPS_TOKEN,
                    interactive: true,
                    padding: 0.1
                });
                map.addLayer(nauticalLayer);
                showToast('Nautical charts loaded successfully', 'success');
                return true;
            } catch (error) {
                console.error('Nautical layer error:', error);
                showToast(`Chart loading failed: ${error.message}`, 'error');
                return false;
            }
        }

        /**
         * Updates the location display based on current map center and zoom level
         */
        function updateLocationDisplay() {
            const center = map.getCenter();
            const zoom = map.getZoom();
            reverseGeocode(center.lat, center.lng, zoom);
        }

        /**
         * Reverse geocodes coordinates to get a readable location name based on zoom level
         * @param {number} lat - Latitude
         * @param {number} lng - Longitude 
         * @param {number} zoom - Current map zoom level
         */
        async function reverseGeocode(lat, lng, zoom) {
            try {
                // Adjust the zoom parameter for Nominatim based on our map zoom
                // Higher zoom = more detail, lower zoom = more general
                let nominatimZoom;
                if (zoom >= 15) nominatimZoom = 18;        // Very detailed (street level)
                else if (zoom >= 13) nominatimZoom = 16;   // Detailed (neighborhood/harbor)
                else if (zoom >= 11) nominatimZoom = 14;   // Moderate (city/bay)
                else if (zoom >= 9) nominatimZoom = 12;    // General (region/county)
                else if (zoom >= 7) nominatimZoom = 10;    // Broad (state/province)
                else nominatimZoom = 8;                    // Very broad (country/large region)

                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=${nominatimZoom}&addressdetails=1`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.display_name) {
                        const address = data.address || {};
                        let locationName = getLocationByZoomLevel(address, zoom);
                        
                        document.getElementById('current-location').textContent = locationName || 'Unknown Waters';
                    }
                }
            } catch (error) {
                // Silently fail for reverse geocoding - not critical functionality
                console.log('Reverse geocoding unavailable');
            }
        }

        /**
         * Determines appropriate location name based on zoom level
         * @param {Object} address - Address components from Nominatim
         * @param {number} zoom - Current map zoom level
         * @returns {string} - Formatted location name
         */
        function getLocationByZoomLevel(address, zoom) {
            // Very detailed view (15+ zoom) - Show specific locations
            if (zoom >= 15) {
                if (address.marina) return `${address.marina} Marina`;
                if (address.harbour) return `${address.harbour} Harbor`;
                if (address.bay) return `${address.bay} Bay`;
                if (address.pier) return `${address.pier} Pier`;
                if (address.waterway) return `${address.waterway}`;
                if (address.neighbourhood) return `${address.neighbourhood}`;
                if (address.suburb) return `${address.suburb}`;
                if (address.road && address.house_number) return `${address.house_number} ${address.road}`;
                if (address.road) return `${address.road}`;
            }
            
            // Detailed view (13-14 zoom) - Show harbors, bays, neighborhoods
            if (zoom >= 13) {
                if (address.marina) return `${address.marina} Marina`;
                if (address.harbour) return `${address.harbour} Harbor`;
                if (address.bay) return `${address.bay} Bay`;
                if (address.neighbourhood) return `${address.neighbourhood}`;
                if (address.suburb) return `${address.suburb}`;
                if (address.village) return `${address.village}`;
                if (address.town) return `${address.town}`;
            }
            
            // Moderate view (11-12 zoom) - Show cities, bays, general areas
            if (zoom >= 11) {
                if (address.bay) return `${address.bay} Bay`;
                if (address.city) return `${address.city}`;
                if (address.town) return `${address.town}`;
                if (address.village) return `${address.village}`;
                if (address.municipality) return `${address.municipality}`;
            }
            
            // General view (9-10 zoom) - Show regions, counties
            if (zoom >= 9) {
                if (address.county && address.state) {
                    return `${address.county}, ${address.state}`;
                }
                if (address.city && address.state) {
                    return `${address.city}, ${address.state}`;
                }
                if (address.state_district) return `${address.state_district}`;
                if (address.county) return `${address.county}`;
            }
            
            // Broad view (7-8 zoom) - Show states/provinces
            if (zoom >= 7) {
                if (address.state && address.country_code) {
                    const countryCode = address.country_code.toUpperCase();
                    return `${address.state}, ${countryCode}`;
                }
                if (address.state) return `${address.state}`;
                if (address.region) return `${address.region}`;
            }
            
            // Very broad view (< 7 zoom) - Show countries, major regions
            if (address.country) {
                if (address.continent && zoom < 4) {
                    return `${address.continent}`;
                }
                return `${address.country}`;
            }
            
            // Ultimate fallback
            return 'Open Waters';
        }

        window.goToLocation = (lat, lng, name) => {
            map.setView([lat, lng], 13);
            document.getElementById('current-location').textContent = name;
            showToast(`Navigated to ${name}`, 'success');
        };

        window.getCurrentLocation = () => {
            if (navigator.geolocation) {
                showToast('Acquiring position...', 'info');
                navigator.geolocation.getCurrentPosition(position => {
                    const { latitude, longitude } = position.coords;
                    goToLocation(latitude, longitude, 'Your Current Position');
                    showToast('Position acquired successfully', 'success');
                }, (error) => {
                    let message = 'Unable to determine location.';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = 'Location access denied by user.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            message = 'Location request timed out.';
                            break;
                    }
                    showToast(message, 'error');
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                });
            } else {
                showToast('Geolocation not supported by this browser.', 'error');
            }
        };
        
        /**
         * Searches for a location using Nominatim API and moves the map.
         */
        async function searchLocation() {
            const query = document.getElementById('location-search').value.trim();
            if (!query) {
                showToast('Please enter a location to search.', 'info');
                return;
            }
            
            const searchBtn = document.getElementById('search-btn');
            const originalContent = searchBtn.innerHTML;
            
            // Show loading spinner
            searchBtn.innerHTML = '<div class="animate-spin w-4 h-4 border-2 border-white/30 border-t-white rounded-full"></div>';
            searchBtn.disabled = true;
            
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok.');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const { lat, lon, display_name } = data[0];
                    const locationName = display_name.split(',').slice(0, 2).join(',');
                    goToLocation(parseFloat(lat), parseFloat(lon), locationName);
                    showToast(`Found: ${locationName}`, 'success');
                    document.getElementById('location-search').value = '';
                } else {
                    showToast('Location not found. Try a different search.', 'warning');
                }
            } catch (error) {
                console.error('Search error:', error);
                showToast('Search service unavailable.', 'error');
            } finally {
                searchBtn.innerHTML = originalContent;
                searchBtn.disabled = false;
            }
        }
        
        // --- UI and Event Handlers ---

        function setupEventListeners() {
            // Layer switcher
            document.querySelectorAll('input[name="baselayer"]').forEach(radio => {
                radio.addEventListener('change', (e) => switchToLayer(e.target.value));
            });
            
            // Location Search
            document.getElementById('search-btn').addEventListener('click', searchLocation);
            document.getElementById('location-search').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchLocation();
            });

            // Map events
            map.on('mousemove', e => {
                const lat = e.latlng.lat.toFixed(4);
                const lng = Math.abs(e.latlng.lng).toFixed(4);
                const latDir = e.latlng.lat >= 0 ? 'N' : 'S';
                const lngDir = e.latlng.lng >= 0 ? 'E' : 'W';
                document.getElementById('coordinates').textContent = `${lat}°${latDir}, ${lng}°${lngDir}`;
            });

            // Update location display when map stops moving
            let moveTimeout;
            map.on('movestart', () => {
                if (moveTimeout) clearTimeout(moveTimeout);
            });
            
            map.on('moveend', () => {
                // Debounce the location update to avoid too many API calls
                if (moveTimeout) clearTimeout(moveTimeout);
                moveTimeout = setTimeout(updateLocationDisplay, 1000);
            });

            // Initial location update
            setTimeout(updateLocationDisplay, 2000);
            
            // Panel toggles
            document.getElementById('info-toggle').addEventListener('click', (e) => {
                document.getElementById('info-panel-wrapper').classList.toggle('panel-wrapper-collapsed-left');
                e.currentTarget.classList.toggle('active');
            });
            
            document.getElementById('controls-toggle').addEventListener('click', (e) => {
                document.getElementById('controls-panel-wrapper').classList.toggle('panel-wrapper-collapsed-right');
                e.currentTarget.classList.toggle('active');
            });
        }

        /**
         * Displays a toast notification with enhanced styling.
         * @param {string} message - The message to show.
         * @param {string} type - 'info', 'success', 'error', or 'warning'.
         */
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let bgColor, borderColor, iconSVG;
            switch (type) {
                case 'success':
                    bgColor = 'from-emerald-500/20 to-green-500/20';
                    borderColor = 'border-emerald-400/30';
                    iconSVG = `<svg class="w-5 h-5 text-emerald-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`;
                    break;
                case 'error':
                    bgColor = 'from-red-500/20 to-rose-500/20';
                    borderColor = 'border-red-400/30';
                    iconSVG = `<svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>`;
                    break;
                case 'warning':
                    bgColor = 'from-amber-500/20 to-yellow-500/20';
                    borderColor = 'border-amber-400/30';
                    iconSVG = `<svg class="w-5 h-5 text-amber-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>`;
                    break;
                default:
                    bgColor = 'from-blue-500/20 to-cyan-500/20';
                    borderColor = 'border-blue-400/30';
                    iconSVG = `<svg class="w-5 h-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>`;
            }

            toast.className = `flex items-center w-full max-w-sm p-4 space-x-3 text-white bg-gradient-to-r ${bgColor} backdrop-blur-xl border ${borderColor} rounded-xl shadow-xl transform transition-all duration-500 translate-y-full opacity-0`;
            toast.style.background = `linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.9))`;
            toast.innerHTML = `
                <div class="flex-shrink-0">${iconSVG}</div>
                <div class="text-sm font-medium flex-1">${message}</div>
            `;
            container.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-y-full', 'opacity-0');
                toast.classList.add('animate-slide-up');
            }, 100);

            // Animate out and remove
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-full');
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, 5000);
        }

        /**
         * Waits for the BLC library to be available before initializing the map.
         */
        function waitForBlcAndInitialize() {
            const maxRetries = 20; // 10 seconds max wait
            let retries = 0;
            const interval = setInterval(() => {
                if (typeof window.blcgl !== 'undefined' && window.blcgl.external_to_js) {
                    clearInterval(interval);
                    console.log('BLC library loaded successfully. Initializing map.');
                    initializeMap();
                    setupEventListeners();
                    showToast('Seawise navigation system ready', 'success');
                } else {
                    retries++;
                    if (retries > maxRetries) {
                        clearInterval(interval);
                        console.warn('BLC library failed to load within timeout.');
                        showToast('Some chart features may be limited', 'warning');
                        initializeMap();
                        setupEventListeners();
                    }
                }
            }, 500);
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', waitForBlcAndInitialize);

    </script>
</body>
</html>