<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sailing Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- i-Boating Nautical Mapping -->
    <link rel='stylesheet' href='https://fishing-app.gpsnauticalcharts.com/i-boating-fishing-marine-navigation-sdk/5.5/blc-maps.css' />
    <script src='https://fishing-app.gpsnauticalcharts.com/i-boating-fishing-marine-navigation-sdk/5.5/blc-maps.js'></script>
    <script src="https://fishing-app.gpsnauticalcharts.com/i-boating-fishing-marine-navigation-sdk/5.5/leaflet-blc-adapter.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617; /* Even darker slate */
            color: #e2e8f0;
            overflow: hidden;
        }

        #app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        #sidebar {
            width: 380px;
            background-color: rgba(15, 23, 42, 0.8); /* Semi-transparent slate */
            backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            z-index: 1000;
            transition: transform 0.3s ease-in-out;
        }

        #map-container {
            flex-grow: 1;
            height: 100%;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }
        
        .luxury-input {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.25);
            transition: all 0.3s ease;
        }

        .luxury-input:focus {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(65, 126, 176, 0.6);
            box-shadow: 0 0 0 3px rgba(65, 126, 176, 0.15);
        }

        .radio-luxury {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            background: rgba(30, 41, 59, 0.6);
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .radio-luxury:checked {
            border-color: #417eb0;
            background: rgba(65, 126, 176, 0.3);
        }
        
        .radio-luxury:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #417eb0;
        }
        
        /* Custom Leaflet Controls */
        .leaflet-control-zoom-in, .leaflet-control-zoom-out {
            background-color: rgba(30, 41, 59, 0.8) !important;
            color: #e2e8f0 !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 8px !important;
        }
        .leaflet-control-zoom-in:hover, .leaflet-control-zoom-out:hover {
            background-color: rgba(51, 65, 85, 0.9) !important;
        }
        .leaflet-bar a {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            #app-container {
                flex-direction: column;
            }
            #sidebar {
                position: absolute;
                top: 0;
                left: 0;
                width: 85%;
                max-width: 320px;
                height: 100%;
                transform: translateX(-100%);
                border-right: 1px solid rgba(255, 255, 255, 0.1);
            }
            #sidebar.open {
                transform: translateX(0);
            }
            #map-container {
                width: 100%;
                height: 100%;
            }
            #sidebar-toggle {
                display: block;
            }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- Left Panel: Sidebar -->
        <div id="sidebar" class="p-4 sm:p-6 flex flex-col">
            <header class="mb-6 flex-shrink-0">
                <h1 class="text-2xl font-bold text-white mb-1">Sailing Map</h1>
                <p class="text-sm text-slate-400">Explore nautical charts and satellite imagery.</p>
            </header>

            <div class="flex-grow overflow-y-auto pr-2">
                <!-- Navigation Search -->
                <div class="space-y-3 mb-6">
                    <label class="font-semibold text-white/90 text-sm flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <span>Navigation Search</span>
                    </label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="location-search" class="luxury-input block w-full rounded-xl px-4 py-3 text-white placeholder-white/50 text-sm focus:outline-none" placeholder="e.g., Nantucket Sound">
                        <button id="search-btn" class="bg-slate-700 hover:bg-slate-600 p-3 rounded-xl text-white/80 shrink-0 transition-colors">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        </button>
                    </div>
                </div>

                <!-- Base Layer Controls -->
                <div class="space-y-4 mb-4">
                    <label class="font-semibold text-white/90 text-sm flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2,17 12,22 22,17"></polyline><polyline points="2,12 12,17 22,12"></polyline></svg>
                        <span>Base Maps</span>
                    </label>
                    <div id="base-layer-grid" class="grid grid-cols-2 gap-3 p-3 bg-slate-800/50 rounded-xl">
                        <!-- Base layers will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Map -->
        <div id="map-container">
            <div id="map"></div>
            <!-- Sidebar Toggle Button for Mobile -->
            <button id="sidebar-toggle" class="md:hidden absolute top-4 left-4 z-[1001] p-2 bg-slate-800/80 backdrop-blur-sm rounded-md text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
    </div>
    
    <script>
        // --- Global Variables ---
        let map;
        let currentBaseLayer = null;
        let baseLayers = {};
        const IBOATING_API_KEY = "wYhXj07uz1kfDTKR1qxuBn";

        // --- Main Application Logic ---
        function initializeMap() {
            map = L.map('map', { 
                zoomControl: false // We disable the default and add a custom one
            }).setView([20, 0], 3); // Start with a global view

            // Add styled zoom control
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);

            baseLayers = {
                nautical: L.blcGL({ blc_access_token: IBOATING_API_KEY }),
                satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
                osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
                terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png')
            };
            
            switchToBaseLayer('nautical');
            updateBaseLayerControlPanel();
        }

        function switchToBaseLayer(layerKey) {
            const newLayer = baseLayers[layerKey];
            if (newLayer && newLayer !== currentBaseLayer) {
                if (currentBaseLayer && map.hasLayer(currentBaseLayer)) {
                    map.removeLayer(currentBaseLayer);
                }
                map.addLayer(newLayer);
                currentBaseLayer = newLayer;
                if (typeof currentBaseLayer.setZIndex === 'function') {
                    currentBaseLayer.setZIndex(0);
                }
            }
        }

        async function searchLocation() {
            const query = document.getElementById('location-search').value.trim();
            if (!query) return;
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data && data.length > 0) {
                    const { lat, lon } = data[0];
                    map.setView([lat, lon], 13);
                } else {
                    alert('Location not found.'); // Using a simple alert for now
                }
            } catch (error) {
                console.error('Search failed:', error);
                alert('Failed to search for location.');
            }
        }

        function updateBaseLayerControlPanel() {
            const grid = document.getElementById('base-layer-grid');
            grid.innerHTML = '';
            const baseLayerInfo = { nautical: 'Nautical', satellite: 'Satellite', osm: 'Coastal', terrain: 'Terrain' };
            Object.keys(baseLayerInfo).forEach(key => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-3';
                div.innerHTML = `<input type="radio" id="${key}" name="baselayer" value="${key}" class="radio-luxury"><label for="${key}" class="text-sm text-white/80 cursor-pointer">${baseLayerInfo[key]}</label>`;
                grid.appendChild(div);
            });
            document.querySelectorAll('input[name="baselayer"]').forEach(radio => radio.addEventListener('change', (e) => switchToBaseLayer(e.target.value)));
            document.querySelector('input[name="baselayer"][value="nautical"]').checked = true;
        }
        
        function setupSidebarToggle() {
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('sidebar-toggle');
            
            toggleButton.addEventListener('click', (e) => {
                e.stopPropagation();
                sidebar.classList.toggle('open');
                // After the transition, tell the map to resize itself
                setTimeout(() => {
                    map.invalidateSize();
                }, 300);
            });

            // Close sidebar if clicking outside of it on mobile
            document.getElementById('map-container').addEventListener('click', () => {
                if (sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                     setTimeout(() => {
                        map.invalidateSize();
                    }, 300);
                }
            });
        }


        document.addEventListener('DOMContentLoaded', async () => {
            initializeMap();
            setupSidebarToggle();
            document.getElementById('search-btn').addEventListener('click', searchLocation);
            document.getElementById('location-search').addEventListener('keypress', (e) => { if (e.key === 'Enter') searchLocation(); });
        });
    </script>
</body>
</html>
