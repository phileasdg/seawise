<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seawise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- i-Boating Nautical Mapping -->
    <link rel='stylesheet' href='https://fishing-app.gpsnauticalcharts.com/i-boating-fishing-marine-navigation-sdk/5.5/blc-maps.css' />
    <script src='https://fishing-app.gpsnauticalcharts.com/i-boating-fishing-marine-navigation-sdk/5.5/blc-maps.js'></script>
    <script src="https://fishing-app.gpsnauticalcharts.com/i-boating-fishing-marine-navigation-sdk/5.5/leaflet-blc-adapter.js"></script>

    <style>
        :root {
            --dark-bg: #0f172a; /* Darker navy */
            --panel-bg: #1e293b; /* Slate */
            --border-color: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-color: #38bdf8; /* Sky blue */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-primary);
            overflow: hidden;
        }
        
        #app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        #sidebar {
            width: 350px;
            background-color: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            z-index: 1001;
            transition: transform 0.3s ease-in-out;
            flex-shrink: 0;
        }

        #map-container {
            flex-grow: 1;
            height: 100%;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            background-color: var(--dark-bg);
        }
        
        .control-input {
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            color: var(--text-primary);
            border-radius: 6px;
        }

        .control-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
            outline: none;
        }
        
        .control-input::placeholder {
            color: var(--text-secondary);
        }

        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem 0;
        }
        .radio-custom {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            margin-right: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: border-color 0.2s ease;
        }
        .radio-custom::after {
            content: '';
            width: 8px;
            height: 8px;
            background-color: var(--accent-color);
            border-radius: 50%;
            transform: scale(0);
            transition: transform 0.2s ease;
        }
        input[type="radio"]:checked + .radio-custom {
            border-color: var(--accent-color);
        }
        input[type="radio"]:checked + .radio-custom::after {
            transform: scale(1);
        }

        
        /* Custom Leaflet Controls */
        .leaflet-control-zoom {
             border: 1px solid var(--border-color) !important;
             border-radius: 6px !important;
             overflow: hidden;
        }
        .leaflet-control-zoom-in, .leaflet-control-zoom-out {
            background-color: var(--panel-bg) !important;
            color: var(--text-primary) !important;
            width: 32px !important;
            height: 32px !important;
            line-height: 32px !important;
        }
        .leaflet-control-zoom-in:hover, .leaflet-control-zoom-out:hover {
            background-color: #374151 !important;
        }
        .leaflet-bar a {
            border-bottom: 1px solid var(--border-color) !important;
        }
        .leaflet-bar a:last-child {
            border-bottom: none !important;
        }

        /* Notification Styling */
        #notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translate(-50%, 200%);
            background-color: var(--panel-bg);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            z-index: 2000;
            transition: transform 0.5s ease-in-out;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        #notification.show {
            transform: translate(-50%, 0);
        }
        
        #coords-container {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            background-color: rgba(31, 41, 55, 0.8);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            font-family: 'monospace';
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            #sidebar {
                position: absolute;
                transform: translateX(-100%);
                width: 85%;
                max-width: 320px;
            }
            #sidebar.open {
                transform: translateX(0);
            }
            #map-container {
                width: 100%;
                height: 100%;
            }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <div id="sidebar" class="flex flex-col">
            <header class="p-6 flex-shrink-0 text-left border-b border-gray-700 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-white">Seawise</h1>
                <button id="panel-close" class="md:hidden p-1 text-gray-400 hover:text-white">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </header>

            <div class="flex-grow overflow-y-auto">
                <div class="p-6 space-y-3 border-b border-gray-700">
                    <label class="font-semibold text-sm text-gray-400">LOCATION SEARCH</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="location-search" class="control-input block w-full px-3 py-2" placeholder="e.g., Nantucket Sound">
                        <button id="search-btn" class="bg-gray-700 hover:bg-gray-600 p-2.5 rounded-md text-gray-300 shrink-0 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        </button>
                    </div>
                </div>

                <div class="p-6 space-y-3 border-b border-gray-700">
                    <span class="font-semibold text-sm text-gray-400">MAP LAYERS</span>
                    <div id="base-layer-grid" class="space-y-2">
                        <!-- Base layers will be added here dynamically -->
                    </div>
                </div>
                
                <div class="p-6 space-y-3">
                    <span class="font-semibold text-sm text-gray-400">TOOLS</span>
                    <button id="find-me-btn" class="w-full text-left p-3 flex items-center space-x-3 hover:bg-gray-700/50 rounded-md transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><line x1="22" y1="12" x2="18" y2="12"></line><line x1="6" y1="12" x2="2" y2="12"></line><line x1="12" y1="6" x2="12" y2="2"></line><line x1="12" y1="22" x2="12" y2="18"></line></svg>
                        <span class="text-sm text-gray-300">Find My Location</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="map-container">
            <div id="map"></div>
            <button id="panel-toggle" class="absolute top-4 left-4 z-[999] p-2 bg-gray-800/80 backdrop-blur-sm rounded-md text-white md:hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="menu-icon"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
            <div id="coords-container">Lat: --.----, Lng: --.----</div>
        </div>
    </div>
    
    <div id="notification"></div>

    <script>
        let map;
        let currentBaseLayer = null;
        let baseLayers = {};
        const IBOATING_API_KEY = "wYhXj07uz1kfDTKR1qxuBn";

        function showNotification(message, duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        function initializeMap() {
            map = L.map('map', { 
                zoomControl: false 
            }).setView([20, 0], 3);

            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);

            baseLayers = {
                nautical: L.blcGL({ blc_access_token: IBOATING_API_KEY }),
                satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
                osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
                terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png')
            };
            
            switchToBaseLayer('nautical');
            updateBaseLayerControlPanel();
            setupMapInfo();
        }

        function switchToBaseLayer(layerKey) {
            const newLayer = baseLayers[layerKey];
            if (newLayer && newLayer !== currentBaseLayer) {
                if (currentBaseLayer && map.hasLayer(currentBaseLayer)) {
                    map.removeLayer(currentBaseLayer);
                }
                map.addLayer(newLayer);
                currentBaseLayer = newLayer;
            }
        }

        async function searchLocation() {
            const query = document.getElementById('location-search').value.trim();
            if (!query) return;
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data && data.length > 0) {
                    const { lat, lon } = data[0];
                    map.setView([lat, lon], 13);
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.remove('open');
                    }
                } else {
                    showNotification('Location not found.');
                }
            } catch (error) {
                console.error('Search failed:', error);
                showNotification('Failed to search for location.');
            }
        }
        
        function findMyLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 14);
                    L.marker([lat, lng]).addTo(map).bindPopup("Your Location").openPopup();
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.remove('open');
                    }
                }, () => {
                    showNotification('Unable to retrieve your location.');
                });
            } else {
                showNotification('Geolocation is not supported by this browser.');
            }
        }

        function setupMapInfo() {
            const coordsContainer = document.getElementById('coords-container');
            map.on('mousemove', function(e) {
                coordsContainer.innerHTML = `Lat: ${e.latlng.lat.toFixed(4)}, Lng: ${e.latlng.lng.toFixed(4)}`;
            });
            map.on('mouseout', function() {
                 coordsContainer.innerHTML = 'Lat: --.----, Lng: --.----';
            });
        }

        function updateBaseLayerControlPanel() {
            const grid = document.getElementById('base-layer-grid');
            grid.innerHTML = '';
            const baseLayerInfo = { nautical: 'Nautical', satellite: 'Satellite', osm: 'Coastal', terrain: 'Terrain' };
            Object.keys(baseLayerInfo).forEach(key => {
                const label = document.createElement('label');
                label.className = 'radio-label text-sm text-gray-300';
                label.innerHTML = `
                    <input type="radio" id="baselayer-${key}" name="baselayer" value="${key}" class="hidden">
                    <span class="radio-custom"></span>
                    <span>${baseLayerInfo[key]}</span>
                `;
                grid.appendChild(label);
            });
            document.querySelectorAll('input[name="baselayer"]').forEach(radio => radio.addEventListener('change', (e) => switchToBaseLayer(e.target.value)));
            document.querySelector('input[name="baselayer"][value="nautical"]').checked = true;
        }
        
        function setupPanelToggle() {
            const panel = document.getElementById('sidebar');
            const toggleButton = document.getElementById('panel-toggle');
            const closeButton = document.getElementById('panel-close');
            
            const openPanel = () => {
                panel.classList.add('open');
                setTimeout(() => { map.invalidateSize(); }, 300);
            };

            const closePanel = () => {
                panel.classList.remove('open');
                setTimeout(() => { map.invalidateSize(); }, 300);
            };

            toggleButton.addEventListener('click', (e) => {
                e.stopPropagation();
                openPanel();
            });

            closeButton.addEventListener('click', (e) => {
                e.stopPropagation();
                closePanel();
            });
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            initializeMap();
            setupPanelToggle();
            document.getElementById('search-btn').addEventListener('click', searchLocation);
            document.getElementById('location-search').addEventListener('keypress', (e) => { if (e.key === 'Enter') searchLocation(); });
            document.getElementById('find-me-btn').addEventListener('click', findMyLocation);
        });
    </script>
</body>
</html>
